<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>EV Route Planner with Charging Stop</title>
</head>
<body>
  <h1>EV Route Planner with Charging Stop</h1>
  <script>
    const apiKey = '0ff228e397b043d8a388d6f0d6599014'; // Replace with your actual API key

    // For the Places API, use [lon, lat] order:
    const startCoordPlaces = [-77.0365, 38.8977]; // [lon, lat]
    const endCoordPlaces   = [-77.0434, 38.9097]; // [lon, lat]

    // Helper: Compute a bounding box from two points (in [lon, lat] order) with a buffer
    function computeBBox(coord1, coord2, buffer = 0.01) {
      const minLon = Math.min(coord1[0], coord2[0]) - buffer;
      const minLat = Math.min(coord1[1], coord2[1]) - buffer;
      const maxLon = Math.max(coord1[0], coord2[0]) + buffer;
      const maxLat = Math.max(coord1[1], coord2[1]) + buffer;
      return `${minLon},${minLat},${maxLon},${maxLat}`;
    }
    
    const bbox = computeBBox(startCoordPlaces, endCoordPlaces);
    
    // Build the Places API URL to search for charging stations within the bounding box (lon,lat order)
    const placesUrl = `https://api.geoapify.com/v2/places?categories=service.vehicle.charging_station&filter=rect:${bbox}&limit=5&apiKey=${apiKey}`;
    
    // Query charging stations
    fetch(placesUrl)
      .then(response => response.json())
      .then(placesData => {
        console.log("Charging Stations Data:", placesData);
        if (!placesData.features || placesData.features.length === 0) {
          throw new Error("No charging stations found.");
        }
        // Select the first charging station (its coordinates are in [lon, lat] order)
        const chargingStation = placesData.features[0];
        const csCoordsLonLat = chargingStation.geometry.coordinates;
        console.log("Selected Charging Station:", chargingStation.properties, csCoordsLonLat);
        
        // For the Routing API, we need [lat, lon] order.
        // Convert the charging station coordinate from [lon, lat] to [lat, lon]:
        const csCoordsLatLon = [csCoordsLonLat[1], csCoordsLonLat[0]];
        
        // For the Routing API, define start and end in [lat, lon] order:
        const startRouting = [38.8977, -77.0365]; // [lat, lon]
        const endRouting   = [38.9097, -77.0434]; // [lat, lon]
        
        // Build waypoints string (lat,lon order) including the charging station:
        const waypoints = [
          startRouting.join(','),
          csCoordsLatLon.join(','),
          endRouting.join(',')
        ];
        
        // Build the Routing API URL:
        const routingUrl = `https://api.geoapify.com/v1/routing?waypoints=${waypoints.join('|')}&mode=drive&apiKey=${apiKey}`;
        console.log("Routing URL:", routingUrl);
        return fetch(routingUrl);
      })
      .then(response => response.json())
      .then(routeData => {
        console.log("Route Data with Charging Stop:", routeData);
        // Process and display the route as needed.
      })
      .catch(err => console.error("Error:", err));
  </script>
</body>
</html>
